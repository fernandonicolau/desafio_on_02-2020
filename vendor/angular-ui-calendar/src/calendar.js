angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$locale",function(n,e){var a=n.eventSources,r=n.calendarWatchEvent?n.calendarWatchEvent:angular.noop,t=1;this.eventFingerprint=function(n){n._id||(n._id=t++);var e=r({event:n})||"",a=moment.isMoment(n.start)?n.start.unix():n.start?moment(n.start).unix():"",l=moment.isMoment(n.end)?n.end.unix():n.end?moment(n.end).unix():"";return[n._id,n.id||"",n.title||"",n.url||"",a,l,n.allDay||"",n.className||"",e].join("")};var l=1,u=1;this.sourceFingerprint=function(n){var e=""+(n.__id||(n.__id=l++)),a=angular.isObject(n)&&n.events;return a&&(e=e+"-"+(a.__id||(a.__id=u++))),e},this.allEvents=function(){return Array.prototype.concat.apply([],(a||[]).reduce(function(n,e){if(angular.isArray(e))n.push(e);else if(angular.isObject(e)&&angular.isArray(e.events)){var a=Object.keys(e).filter(function(n){return"_id"!==n&&"events"!==n});e.events.forEach(function(n){angular.extend(n,a)}),n.push(e.events)}return n},[]))},this.changeWatcher=function(n,e){var a,r=function(){return((angular.isFunction(n)?n():n)||[]).reduce(function(n,a){var r=e(a);return l[r]=a,n.push(r),n},[])},t=function(n,e){var a=(e||[]).reduce(function(n,e){return n[e]=!0,n},Object.create(null));return(n||[]).filter(function(n){return!a[n]})},l={};return a={subscribe:function(n,u){n.$watch(r,function(n,r){!(u&&!1===u(n,r))&&function(n,r){var u,o,i={},d=t(r,n);for(u=0;u<d.length;u++){var c=d[u],f=l[c];delete l[c];var s=e(f);s===c?a.onRemoved(f):(i[s]=c,a.onChanged(f))}var v=t(n,r);for(u=0;u<v.length;u++)i[o=v[u]]||a.onAdded(l[o])}(n,r)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}},this.getFullCalendarConfig=function(e,a){var r={};return angular.extend(r,a),angular.extend(r,e),angular.forEach(r,function(e,a){var t;"function"==typeof e&&(r[a]=(t=r[a],function(){if(n.$root.$$phase)return t.apply(this,arguments);var e=arguments,a=this;return n.$root.$apply(function(){return t.apply(a,e)})}))}),r},this.getLocaleConfig=function(n){if(!n.lang||n.useNgLocale){var a=function(n){return(Object.keys(n)||[]).reduce(function(e,a){return e.push(n[a]),e},[])},r=e.DATETIME_FORMATS;return{monthNames:a(r.MONTH),monthNamesShort:a(r.SHORTMONTH),dayNames:a(r.DAY),dayNamesShort:a(r.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(n){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(e,a,r,t){var l,u=e.eventSources,o=!1,i=t.changeWatcher(u,t.sourceFingerprint),d=t.changeWatcher(t.allEvents,t.eventFingerprint),c=null;e.destroyCalendar=function(){l&&l.fullCalendar&&l.fullCalendar("destroy"),l=r.calendar?n.calendars[r.calendar]=angular.element(a).html(""):angular.element(a).html("")},e.initCalendar=function(){l||(l=angular.element(a).html("")),l.fullCalendar(c),r.calendar&&(n.calendars[r.calendar]=l)},e.$on("$destroy",function(){e.destroyCalendar()}),i.onAdded=function(e){l&&l.fullCalendar&&(l.fullCalendar(c),r.calendar&&(n.calendars[r.calendar]=l),l.fullCalendar("addEventSource",e),o=!0)},i.onRemoved=function(n){l&&l.fullCalendar&&(l.fullCalendar("removeEventSource",n),o=!0)},i.onChanged=function(){l&&l.fullCalendar&&(l.fullCalendar("refetchEvents"),o=!0)},d.onAdded=function(n){l&&l.fullCalendar&&l.fullCalendar("renderEvent",n,!!n.stick)},d.onRemoved=function(n){l&&l.fullCalendar&&l.fullCalendar("removeEvents",n._id)},d.onChanged=function(n){if(l&&l.fullCalendar)for(var e=l.fullCalendar("clientEvents",n._id),a=0;a<e.length;a++){var r=e[a];r=angular.extend(r,n),l.fullCalendar("updateEvent",r)}},i.subscribe(e),d.subscribe(e,function(){if(!0===o)return o=!1,!1}),e.$watch(function(){var a=r.uiCalendar?e.$parent.$eval(r.uiCalendar):{},l=t.getFullCalendarConfig(a,n),o=t.getLocaleConfig(l);angular.extend(o,l),c={eventSources:u},angular.extend(c,o),c.calendars=null;var i={};for(var d in c)"eventSources"!==d&&(i[d]=c[d]);return JSON.stringify(i)},function(n,a){n!==a?(e.destroyCalendar(),e.initCalendar()):n&&angular.isUndefined(l)&&e.initCalendar()})}}}]);